<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TimeFlow PWA</title>
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1e293b">
    <meta name="description" content="TimeFlow lets you track, review, and analyze timesheets even when you're offline.">

    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.svg" type="image/svg+xml" sizes="any">
    <link rel="apple-touch-icon" href="icon.svg">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        body {
            overscroll-behavior-y: none;
            -webkit-tap-highlight-color: transparent;
        }

        .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
        .nav-safe-area { padding-bottom: calc(env(safe-area-inset-bottom, 0px) + 12px); }
        
        /* Mobile Tab Bar Scrolling */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 h-[100dvh] w-screen overflow-hidden flex flex-col font-sans">

    <div id="root" class="h-full w-full flex flex-col"></div>

    <script>
        if ('serviceWorker' in navigator && !window.location.href.startsWith('blob:')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .catch(err => console.log('Service worker registration failed or skipped in blob/sandbox', err));
            });
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        console.log("Current URL:", window.location.href);

        // Helper to bypass confirm in sandbox environment
        const safeConfirm = (message) => {
            if (window.location.href.startsWith('blob:')) return true;
            return confirm(message);
        };

        // --- Icons ---
        const IconList = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>;
        const IconChart = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>;
        const IconSettings = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.72v-.51a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconPlay = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconPlayOutline = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"/></svg>;
        const IconStop = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="none" className={className}><rect x="6" y="6" width="12" height="12" rx="2"/></svg>;
        const IconBriefcase = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>;
        const IconCoffee = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>;
        const IconTrash = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const IconCalendar = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>;
        const IconChevronLeft = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="15 18 9 12 15 6"/></svg>;
        const IconChevronRight = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 18 15 12 9 6"/></svg>;
        const IconFilter = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;
        const IconFolder = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>;
        const IconMerge = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2v20"/><path d="M2 12h20"/></svg>;
        const IconTable = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"/></svg>;
        const IconEdit = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const IconSplit = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M12 3v6a4 4 0 0 0 4 4h5"/>
                <path d="M12 3v6a4 4 0 0 1-4 4H3"/>
                <path d="m19 9 2 2-2 2"/>
                <path d="m5 9-2 2 2 2"/>
            </svg>
        );
        const IconPlus = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19" />
                <line x1="5" y1="12" x2="19" y2="12" />
            </svg>
        );
        const IconCombine = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="16 3 21 3 21 8" />
                <line x1="4" y1="20" x2="21" y2="3" />
                <polyline points="21 16 21 21 16 21" />
                <line x1="15" y1="15" x2="21" y2="21" />
                <line x1="4" y1="4" x2="9" y2="9" />
            </svg>
        );
        const IconReplace = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                 <path d="M14 9l6 6-6 6"/>
                 <path d="M4 4v5a4 4 0 0 0 4 4h10"/>
                 <path d="M10 15l-6-6 6-6"/>
            </svg>
        );

        // --- Utilities ---
        const generateId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
        
        const formatTime = (ts) => new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false });
        
        const formatDate = (ts) => new Date(ts).toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });

        const getDuration = (start, end, showSeconds = false) => {
            const e = end || Date.now();
            const diff = e - start;
            if (diff < 0) return showSeconds ? "00:00:00" : "00:00";
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            if (showSeconds) {
                return `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
            }
            return `${h}h ${m}m`;
        };

        const getStartOfDay = (d) => {
            const date = new Date(d);
            date.setHours(0,0,0,0);
            return date.getTime();
        };

        const getPayPeriodBounds = (dateObj) => {
            const y = dateObj.getFullYear();
            const m = dateObj.getMonth();
            const d = dateObj.getDate();
            
            if (d <= 15) {
                return {
                    start: new Date(y, m, 1).getTime(),
                    end: new Date(y, m, 15, 23, 59, 59, 999).getTime(),
                    label: `1st-15th ${dateObj.toLocaleDateString([], {month:'short', year:'numeric'})}`,
                    days: 15
                };
            } else {
                const lastDay = new Date(y, m + 1, 0);
                return {
                    start: new Date(y, m, 16).getTime(),
                    end: lastDay.getTime(),
                    label: `16th-End ${dateObj.toLocaleDateString([], {month:'short', year:'numeric'})}`,
                    days: lastDay.getDate() - 15
                };
            }
        };

        const isWeekend = (ts) => {
            const day = new Date(ts).getDay();
            return day === 0 || day === 6;
        };
        
        const countWorkDays = (start, end) => {
            let count = 0;
            let cur = new Date(start);
            const stop = new Date(end);
            while(cur <= stop) {
                const day = cur.getDay();
                if(day !== 0 && day !== 6) count++;
                cur.setDate(cur.getDate() + 1);
            }
            return count;
        };

        const TASK_COLORS = ['#3b82f6', '#10b981', '#f97316', '#ef4444', '#8b5cf6', '#06b6d4', '#a855f7', '#f59e0b'];

        const pickNextColor = (usedColors = new Set()) => {
            for (const c of TASK_COLORS) {
                if (!usedColors.has(c)) return c;
            }
            const idx = usedColors.size % TASK_COLORS.length;
            return TASK_COLORS[idx];
        };

        const withAlpha = (color, alpha = 0.15) => {
            if (!color) return `rgba(59,130,246,${alpha})`;
            let hex = color.replace('#', '');
            if (hex.length === 3) hex = hex.split('').map(ch => ch + ch).join('');
            if (hex.length !== 6) return `rgba(59,130,246,${alpha})`;
            const num = parseInt(hex, 16);
            const r = (num >> 16) & 255;
            const g = (num >> 8) & 255;
            const b = num & 255;
            return `rgba(${r},${g},${b},${alpha})`;
        };

        const ensureTaskColors = (entries) => {
            const used = new Set(entries.filter(e => e.color).map(e => e.color));
            const titleColors = {};

            return entries.map(e => {
                const title = e.title || 'Untitled Task';
                const existingColor = e.color || titleColors[title];
                if (existingColor) {
                    titleColors[title] = existingColor;
                    return { ...e, color: existingColor };
                }

                const color = pickNextColor(used);
                used.add(color);
                titleColors[title] = color;
                return { ...e, color };
            });
        };

        const getTaskColor = (title, entries) => {
            const match = entries.find(e => e.title && e.title.toLowerCase() === title.toLowerCase() && e.color);
            if (match) return match.color;
            const used = new Set(entries.filter(e => e.color).map(e => e.color));
            return pickNextColor(used);
        };

        // --- Sample Data ---
        const SAMPLE_DATA = ensureTaskColors(Array.from({length: 40}).map((_, i) => {
            const date = new Date();
            date.setDate(date.getDate() - i);
            date.setHours(9, 0, 0, 0);
            const start = date.getTime();
            const end = start + 8 * 3600000;
            return {
                id: `sample-${i}`,
                title: i % 3 === 0 ? "Development" : (i % 3 === 1 ? "Meetings" : "Design"),
                start: start,
                end: end,
                category: "work",
                chargeCode: i % 3 === 0 ? "DEV-001" : (i % 3 === 1 ? "OPS-002" : "DES-003"),
                description: i % 5 === 0 ? "Focused work session" : ""
            };
        }));

        // --- Storage Hook ---
        const useTimesheetData = () => {
            const [entries, setEntries] = useState([]);

            const loadData = () => {
                try {
                    const saved = localStorage.getItem('timesheet_data');
                    if (saved) {
                        setEntries(ensureTaskColors(JSON.parse(saved)));
                    } else {
                        // Check for sandbox/blob environment
                        const isSandbox = window.location.href.includes('scf.usercontent.goog') || window.location.href.startsWith('blob:');
                        if (isSandbox) {
                            setEntries(SAMPLE_DATA);
                        }
                    }
                } catch (e) {
                    console.error("Failed to load data", e);
                }
            };

            useEffect(() => { loadData(); }, []);

            useEffect(() => {
                const handleStorageChange = (e) => { if (e.key === 'timesheet_data') loadData(); };
                const interval = setInterval(loadData, 5000);
                window.addEventListener('storage', handleStorageChange);
                window.addEventListener('focus', loadData);
                return () => {
                    window.removeEventListener('storage', handleStorageChange);
                    window.removeEventListener('focus', loadData);
                    clearInterval(interval);
                };
            }, []);

            const updateEntries = (newEntries) => {
                const normalized = ensureTaskColors(newEntries);
                setEntries(normalized);
                localStorage.setItem('timesheet_data', JSON.stringify(normalized));
            };

            return [entries, updateEntries];
        };

        // --- Autocomplete ---
        const AutocompleteInput = ({ value, onChange, onSelect, onBlur, disabled, existingTasks, className, autoFocus }) => {
            const [suggestions, setSuggestions] = useState([]);
            const [showSuggestions, setShowSuggestions] = useState(false);
            const wrapperRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => {
                if (autoFocus && inputRef.current) inputRef.current.focus();
            }, [autoFocus]);

            useEffect(() => {
                if (!value || !showSuggestions) { setSuggestions([]); return; }
                const lowerVal = value.toLowerCase();
                const matches = existingTasks.filter(t => t.toLowerCase().includes(lowerVal) && t.toLowerCase() !== lowerVal).slice(0, 5);
                setSuggestions(matches);
            }, [value, existingTasks, showSuggestions]);

            useEffect(() => {
                const handleClickOutside = (event) => { if (wrapperRef.current && !wrapperRef.current.contains(event.target)) setShowSuggestions(false); };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, [wrapperRef]);

            const handleBlur = (e) => {
                // Give time for click on suggestion to register
                setTimeout(() => {
                    if (onBlur) onBlur();
                }, 200);
            };

            return (
                <div ref={wrapperRef} className="relative flex-1">
                    <input 
                        ref={inputRef}
                        type="text" placeholder="What are you working on?" 
                        className={className || "w-full bg-slate-100 border-0 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 focus:outline-none"}
                        value={value} 
                        onChange={(e) => { onChange(e.target.value); setShowSuggestions(true); }}
                        onFocus={() => setShowSuggestions(true)}
                        onBlur={handleBlur}
                        onKeyDown={(e) => { 
                            if (e.key === 'Enter') { 
                                e.preventDefault(); 
                                onSelect(value); 
                                setShowSuggestions(false); 
                                if(onBlur) onBlur();
                            }
                        }}
                        disabled={disabled}
                    />
                    {showSuggestions && suggestions.length > 0 && (
                        <ul className="absolute z-50 left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto">
                            {suggestions.map((s, i) => (
                                <li key={i} className="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm text-slate-700 border-b border-slate-50 last:border-0"
                                    onMouseDown={(e) => { 
                                        e.preventDefault(); // Prevent blur before click
                                        onChange(s); 
                                        onSelect(s); 
                                        setShowSuggestions(false);
                                        if(onBlur) onBlur();
                                    }}
                                >{s}</li>
                            ))}
                        </ul>
                    )}
                </div>
            );
        };

        // --- Common Components ---
        const TimerControls = ({ ts, onChange }) => {
            const adjust = (amount) => onChange(ts + amount * 60 * 1000);
            return (
                <div className="flex items-center space-x-1 bg-slate-100 rounded p-1">
                    <button onClick={() => adjust(-60)} className="p-1 hover:bg-slate-200 rounded text-xs font-bold text-slate-500">-1h</button>
                    <button onClick={() => adjust(-15)} className="p-1 hover:bg-slate-200 rounded text-xs font-bold text-slate-500">-15m</button>
                    <span className="font-mono text-sm px-2 cursor-pointer border-b border-transparent hover:border-slate-400">{formatTime(ts)}</span>
                    <button onClick={() => adjust(15)} className="p-1 hover:bg-slate-200 rounded text-xs font-bold text-slate-500">+15m</button>
                    <button onClick={() => adjust(60)} className="p-1 hover:bg-slate-200 rounded text-xs font-bold text-slate-500">+1h</button>
                </div>
            );
        };

        const EntryCard = ({ entry, onUpdate, onDelete, onSplit, onEdit, onMerge, onRestart, onRecategorize, canMerge, existingTasks, tick }) => {
            const duration = useMemo(() => getDuration(entry.start, entry.end, !entry.end), [entry.start, entry.end, tick]);
            const [isEditingDesc, setIsEditingDesc] = useState(false);
            const [isEditingTitle, setIsEditingTitle] = useState(false);
            const [descValue, setDescValue] = useState(entry.description || '');
            const accentColor = entry.color || '#2563eb';

            useEffect(() => {
                setDescValue(entry.description || '');
            }, [entry.description]);

            const handleDescSave = () => {
                if (descValue !== entry.description) {
                    onUpdate({ ...entry, description: descValue });
                }
                setIsEditingDesc(false);
            };

            const handleTitleChange = (newTitle) => {
                onUpdate({...entry, title: newTitle});
            };

            return (
                <div className={`bg-white rounded-lg shadow-sm border-l-4 p-4 mb-3 transition-all ${entry.end ? 'border-slate-300' : 'border-green-500 ring-2 ring-green-50 ring-opacity-50'}`} style={{ borderLeftColor: accentColor }}>
                    <div className="flex justify-between items-start mb-2">
                        <div className="flex-1">
                            <div className="flex items-center space-x-2">
                                <span className="w-3 h-3 rounded-full border border-slate-200" style={{ backgroundColor: accentColor }}></span>
                                {isEditingTitle ? (
                                    <AutocompleteInput
                                        value={entry.title}
                                        onChange={handleTitleChange}
                                        onSelect={handleTitleChange}
                                        onBlur={() => setIsEditingTitle(false)}
                                        existingTasks={existingTasks}
                                        className="text-lg font-semibold text-slate-800 w-full border-b border-slate-300 focus:outline-none focus:border-blue-500 bg-transparent"
                                        autoFocus={true}
                                    />
                                ) : (
                                    <h3 
                                        className="text-lg font-semibold text-slate-800 cursor-pointer hover:text-blue-600 truncate pr-2"
                                        onClick={() => setIsEditingTitle(true)}
                                        title="Click to rename"
                                    >
                                        {entry.title || "Untitled Task"}
                                    </h3>
                                )}
                            </div>
                            <div className="flex items-center mt-1 space-x-2">
                                <span className={`flex items-center text-xs px-2 py-0.5 rounded-full ${entry.category === 'work' ? 'bg-blue-100 text-blue-700' : 'bg-orange-100 text-orange-700'}`}>
                                    {entry.category === 'work' ? <IconBriefcase className="w-3 h-3 mr-1"/> : <IconCoffee className="w-3 h-3 mr-1"/>}
                                    {entry.category === 'work' ? 'Work' : 'Non-Work'}
                                </span>
                                <span className="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-0.5 min-w-[3rem] text-center text-slate-600">
                                    {entry.chargeCode || 'No Code'}
                                </span>
                            </div>
                        </div>
                        <div className="flex items-center text-right space-x-2">
                            {entry.end && (
                                <button onClick={() => onRestart(entry)} className="text-slate-400 hover:text-green-600 p-2 rounded-full border border-transparent hover:border-green-200" title="Restart this task">
                                    <IconPlayOutline className="w-6 h-6" />
                                </button>
                            )}
                            <div className="text-xl font-mono font-bold text-slate-700">{duration}</div>
                            { !entry.end && <span className="text-xs text-green-600 font-bold animate-pulse">RUNNING</span> }
                        </div>
                    </div>
                    <div className="flex flex-col space-y-2 mt-3 pt-3 border-t border-slate-100">
                        <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400 font-bold uppercase">Start</span>
                            <TimerControls ts={entry.start} onChange={(val) => onUpdate({...entry, start: val})} />
                        </div>
                        {entry.end ? (
                            <div className="flex justify-between items-center">
                                <span className="text-xs text-slate-400 font-bold uppercase">End</span>
                                <TimerControls ts={entry.end} onChange={(val) => onUpdate({...entry, end: val})} />
                            </div>
                        ) : (
                            <div className="flex justify-end">
                                <button onClick={() => onUpdate({...entry, end: Date.now()})} className="bg-red-50 text-red-600 px-3 py-1 rounded text-sm font-medium hover:bg-red-100 flex items-center">
                                    <IconStop className="w-4 h-4 mr-1"/> Stop Task
                                </button>
                            </div>
                        )}
                        
                        {/* Compact Description Field - Always visible or placeholder */}
                        <div className="mt-2">
                            {isEditingDesc ? (
                                <div className="flex flex-col space-y-1">
                                    <textarea
                                        className="w-full text-sm bg-slate-50 border border-blue-200 rounded p-2 focus:outline-none focus:border-blue-400"
                                        rows={2}
                                        value={descValue}
                                        onChange={(e) => setDescValue(e.target.value)}
                                        onBlur={handleDescSave}
                                        autoFocus
                                        placeholder="Add notes..."
                                        onFocus={(e) => {
                                            const val = e.target.value;
                                            e.target.value = '';
                                            e.target.value = val;
                                        }}
                                    />
                                </div>
                            ) : (
                                <div 
                                    className={`text-sm p-2 rounded cursor-pointer hover:bg-slate-100 border border-transparent hover:border-slate-200 transition-colors ${!entry.description ? 'text-slate-400 italic' : 'text-slate-600 bg-slate-50'}`}
                                    onClick={() => setIsEditingDesc(true)}
                                >
                                    {entry.description || "Add note..."}
                                </div>
                            )}
                        </div>

                        <div className="flex justify-end pt-2 space-x-2">
                             <button onClick={() => onRecategorize(entry)} className="text-slate-400 hover:text-indigo-600 p-2 hover:bg-indigo-50 rounded" title="Recategorize to existing task"><IconReplace className="w-5 h-5" /></button>
                             {canMerge && (
                                <button onClick={() => onMerge(entry)} className="text-slate-400 hover:text-green-600 p-2 hover:bg-green-50 rounded" title="Merge with previous task of same name"><IconCombine className="w-5 h-5" /></button>
                             )}
                             <button onClick={() => onEdit(entry)} className="text-slate-400 hover:text-blue-600 p-2 hover:bg-blue-50 rounded" title="Edit details"><IconEdit className="w-5 h-5" /></button>
                             <button onClick={() => onSplit(entry)} className="text-slate-400 hover:text-blue-600 p-2 hover:bg-blue-50 rounded" title="Split task in half"><IconSplit className="w-5 h-5" /></button>
                             <button onClick={() => onDelete(entry.id)} className="text-slate-400 hover:text-red-500 p-2 hover:bg-red-50 rounded" title="Delete task"><IconTrash className="w-5 h-5" /></button>
                        </div>
                    </div>
                </div>
            );
        };

        const HomeView = ({ entries, updateEntries, tick }) => {
            const [newTaskTitle, setNewTaskTitle] = useState("");
            const [filter, setFilter] = useState('last-7');
            const [splitTarget, setSplitTarget] = useState(null);
            const [splitValue, setSplitValue] = useState(0);
            const [manualModalOpen, setManualModalOpen] = useState(false);
            const [editEntryId, setEditEntryId] = useState(null); 
            const [recategorizeTarget, setRecategorizeTarget] = useState(null);
            const [recatQuery, setRecatQuery] = useState("");
            const [manualForm, setManualForm] = useState({
                title: '',
                date: '',
                startTime: '',
                endTime: '',
                chargeCode: '',
                category: 'work',
                description: '',
                color: ''
            });
            const uniqueTitles = useMemo(() => [...new Set(entries.map(e => e.title))], [entries]);

            const sortedEntries = useMemo(() => {
                const now = Date.now();
                let data = [...entries];
                
                // Sort: Active first, then newest start time
                data.sort((a, b) => {
                    if (!a.end && b.end) return -1;
                    if (a.end && !b.end) return 1;
                    return b.start - a.start;
                });

                // Time-based Filters
                if (filter === 'last-7') {
                    const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
                    data = data.filter(e => e.start >= sevenDaysAgo);
                } else if (filter === 'current-pp') {
                    const bounds = getPayPeriodBounds(new Date(now));
                    data = data.filter(e => e.start >= bounds.start && e.start <= bounds.end);
                } else if (filter === 'last-30') {
                    const thirtyDaysAgo = now - (30 * 24 * 60 * 60 * 1000);
                    data = data.filter(e => e.start >= thirtyDaysAgo);
                }

                return data;
            }, [entries, filter]);

            // Full sorted list for merge checks - sorted by start time (newest first)
            // Logic requires newest first to look ahead for older entries
            const allSortedEntries = useMemo(() => {
                return [...entries].sort((a, b) => b.start - a.start);
            }, [entries]);

            const activeEntry = entries.find(e => !e.end);

            const startTask = (titleToStart, fromRestart = false, extraProps = {}) => {
                let currentEntries = entries;
                if (activeEntry) {
                    const stoppedActive = { ...activeEntry, end: Date.now() };
                    currentEntries = entries.map(e => e.id === activeEntry.id ? stoppedActive : e);
                }
                let title = titleToStart || newTaskTitle || "New Task";
                const match = currentEntries.find(e => e.title.toLowerCase() === title.toLowerCase());
                if(match) title = match.title; 

                const color = extraProps.color || match?.color || getTaskColor(title, currentEntries);
                const category = extraProps.category || match?.category || 'work';
                const chargeCode = extraProps.chargeCode || match?.chargeCode || '';

                updateEntries([...currentEntries, {
                    id: generateId(), title: title, start: Date.now(), end: null,
                    category, chargeCode, color, description: '', ...extraProps
                }]);
                setNewTaskTitle("");
            };

            const handleRestartTask = (entry) => {
                startTask(entry.title, true, {
                    category: entry.category,
                    chargeCode: entry.chargeCode,
                    color: entry.color,
                    description: entry.description 
                });
            };

            const handleUpdate = (updatedEntry) => {
                const oldEntry = entries.find(e => e.id === updatedEntry.id);
                if (!oldEntry) return;

                const titleChanged = oldEntry.title !== updatedEntry.title;
                if (titleChanged) {
                    const match = entries.find(e => e.title.toLowerCase() === updatedEntry.title.toLowerCase() && e.id !== updatedEntry.id);
                    if (match) {
                        updatedEntry.title = match.title; 
                        updatedEntry.chargeCode = match.chargeCode;
                        updatedEntry.category = match.category;
                        updatedEntry.color = match.color;
                    }
                }
                const codeChanged = oldEntry.chargeCode !== updatedEntry.chargeCode;
                const catChanged = oldEntry.category !== updatedEntry.category;
                const colorChanged = oldEntry.color !== updatedEntry.color;

                if ((codeChanged || catChanged || colorChanged) && !titleChanged) {
                    const newEntries = entries.map(e => {
                        if (e.title === updatedEntry.title) {
                            return { ...e, chargeCode: updatedEntry.chargeCode, category: updatedEntry.category, color: updatedEntry.color, ...(e.id === updatedEntry.id ? updatedEntry : {}) };
                        }
                        return e;
                    });
                    updateEntries(newEntries);
                } else {
                    updateEntries(entries.map(e => e.id === updatedEntry.id ? updatedEntry : e));
                }
            };

            const handleDelete = (id) => safeConfirm("Delete this entry?") && updateEntries(entries.filter(e => e.id !== id));
            
            const handleRecategorize = (newTitle) => {
                if(!recategorizeTarget || !newTitle) return;
                const target = recategorizeTarget;
                const match = entries.find(e => e.title.toLowerCase() === newTitle.toLowerCase());
                
                if (!match) {
                    alert("Target task does not exist. Please create it first or select from list.");
                    return;
                }

                const newDesc = `[Was: ${target.title}]\n${target.description || ''}`.trim();
                const updatedEntry = {
                    ...target,
                    title: match.title,
                    color: match.color,
                    chargeCode: match.chargeCode,
                    category: match.category,
                    description: newDesc
                };
                
                updateEntries(entries.map(e => e.id === target.id ? updatedEntry : e));
                setRecategorizeTarget(null);
                setRecatQuery("");
            };

            const handleSplit = (entry) => {
                if (!entry.end) {
                    const splitTs = Date.now();
                    const first = { ...entry, id: generateId(), end: splitTs };
                    const second = { ...entry, id: generateId(), start: splitTs, end: null };
                    const remaining = entries.filter(e => e.id !== entry.id);
                    updateEntries([...remaining, first, second]);
                    return;
                }
                const defaultSplit = entry.start + ((entry.end - entry.start) / 2);
                setSplitTarget(entry);
                setSplitValue(Math.round(defaultSplit));
            };

            const confirmSplit = () => {
                if (!splitTarget || !splitTarget.end) return;
                const safeSplit = Math.min(Math.max(splitValue, splitTarget.start), splitTarget.end);
                const left = { ...splitTarget, id: generateId(), end: safeSplit };
                const right = { ...splitTarget, id: generateId(), start: safeSplit, end: splitTarget.end };
                const remaining = entries.filter(e => e.id !== splitTarget.id);
                updateEntries([...remaining, left, right]);
                setSplitTarget(null);
            };

            const cancelSplit = () => setSplitTarget(null);
            const grouped = useMemo(() => {
                const g = {};
                sortedEntries.forEach(e => { const d = formatDate(e.start); if (!g[d]) g[d] = []; g[d].push(e); });
                return g;
            }, [sortedEntries]);

            const checkMergeability = (entry) => {
                const index = allSortedEntries.findIndex(e => e.id === entry.id);
                if (index === -1 || index >= allSortedEntries.length - 1) return false;
                const olderEntry = allSortedEntries[index + 1];
                return olderEntry && olderEntry.title === entry.title;
            };

            const handleMerge = (entry) => {
                const index = allSortedEntries.findIndex(e => e.id === entry.id);
                if (index === -1 || index >= allSortedEntries.length - 1) return;
                const olderEntry = allSortedEntries[index + 1];
                
                if (olderEntry && olderEntry.title === entry.title) {
                    if (safeConfirm(`Merge with previous task "${olderEntry.title}"?`)) {
                        let newDesc = '';
                        const d1 = (olderEntry.description || '').trim();
                        const d2 = (entry.description || '').trim();

                        if (!d1 && !d2) newDesc = '';
                        else if (d1 && !d2) newDesc = olderEntry.description;
                        else if (!d1 && d2) newDesc = entry.description;
                        else {
                            if (d1.toLowerCase() === d2.toLowerCase()) {
                                 newDesc = entry.description; 
                            } else {
                                 newDesc = olderEntry.description + '\n---\n' + entry.description;
                            }
                        }

                        // Use olderEntry as the base to preserve its metadata (Color, ChargeCode, etc)
                        // Update end time to the newer entry's end (or null if running)
                        const mergedEntry = {
                            ...olderEntry, 
                            id: generateId(), 
                            end: entry.end, 
                            description: newDesc
                        };
                        
                        const remaining = entries.filter(e => e.id !== entry.id && e.id !== olderEntry.id);
                        updateEntries([...remaining, mergedEntry]);
                    }
                }
            };

            // Setup modal for CREATE or EDIT
            const openManualModal = (entryToEdit = null) => {
                const pad = (val) => `${val}`.padStart(2, '0');
                const formatDateInput = (ts) => {
                    const d = new Date(ts);
                    return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
                };
                const formatTimeInput = (ts) => {
                    const d = new Date(ts);
                    return `${pad(d.getHours())}:${pad(d.getMinutes())}`;
                };

                if (entryToEdit) {
                    setEditEntryId(entryToEdit.id);
                    setManualForm({
                        title: entryToEdit.title,
                        date: formatDateInput(entryToEdit.start),
                        startTime: formatTimeInput(entryToEdit.start),
                        endTime: entryToEdit.end ? formatTimeInput(entryToEdit.end) : formatTimeInput(Date.now()),
                        chargeCode: entryToEdit.chargeCode || '',
                        category: entryToEdit.category,
                        description: entryToEdit.description || '',
                        color: entryToEdit.color || ''
                    });
                } else {
                    const now = Date.now();
                    const startTs = now - (now % 60000);
                    const endTs = startTs + 60 * 60000;
                    setEditEntryId(null);
                    setManualForm({
                        title: newTaskTitle || '',
                        date: formatDateInput(startTs),
                        startTime: formatTimeInput(startTs),
                        endTime: formatTimeInput(endTs),
                        chargeCode: '',
                        category: 'work',
                        description: '',
                        color: ''
                    });
                }
                setManualModalOpen(true);
            };

            const handleManualSubmit = (e) => {
                e.preventDefault();
                const title = (manualForm.title || 'New Task').trim();
                if (!manualForm.date || !manualForm.startTime || !manualForm.endTime) {
                    alert('Please provide a date, start time, and end time.');
                    return;
                }

                const start = new Date(`${manualForm.date}T${manualForm.startTime}`);
                const end = new Date(`${manualForm.date}T${manualForm.endTime}`);
                if (isNaN(start.getTime()) || isNaN(end.getTime())) { alert('Invalid date/time.'); return; }
                if (end <= start) { alert('End time must be after start time.'); return; }

                let color = manualForm.color;
                if (!color && !editEntryId) {
                    color = getTaskColor(title, entries);
                }

                const entryData = {
                    id: editEntryId || generateId(),
                    title,
                    start: start.getTime(),
                    end: end.getTime(),
                    category: manualForm.category,
                    chargeCode: manualForm.chargeCode,
                    color,
                    description: manualForm.description || ''
                };

                if (editEntryId) {
                    handleUpdate(entryData);
                } else {
                    updateEntries([...entries, entryData]);
                }
                
                setManualModalOpen(false);
            };

            const onModalTitleChange = (newTitle) => {
                setManualForm(prev => {
                    const match = entries.find(e => e.title.toLowerCase() === newTitle.toLowerCase());
                    if (match) {
                        return {
                            ...prev,
                            title: match.title, 
                            chargeCode: match.chargeCode,
                            category: match.category,
                            color: match.color
                        };
                    }
                    return { ...prev, title: newTitle };
                });
            };

            return (
                <div className="flex flex-col h-full overflow-hidden">
                    <div className="bg-white p-4 shadow-md z-10 shrink-0">
                        <div className="flex justify-between items-center mb-3">
                            <div>
                                <h1 className="text-xl font-bold text-slate-800">TimeFlow</h1>
                                <p className="text-xs text-slate-500">Track & Manage Work</p>
                            </div>
                            <div className="relative inline-block">
                                <select
                                    className="appearance-none bg-slate-100 border border-slate-200 text-slate-700 py-2 px-3 pr-8 rounded leading-tight focus:outline-none focus:bg-white focus:border-slate-500 text-xs font-bold uppercase tracking-wide"
                                    value={filter} onChange={(e) => setFilter(e.target.value)}
                                >
                                    <option value="last-7">Last 7 Days</option>
                                    <option value="current-pp">Current Pay Period</option>
                                    <option value="last-30">Last 30 Days</option>
                                </select>
                                <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-700"><IconFilter className="w-3 h-3" /></div>
                            </div>
                        </div>
                        <div className="flex space-x-2 items-center">
                            <AutocompleteInput value={newTaskTitle} onChange={setNewTaskTitle} onSelect={startTask} disabled={!!activeEntry} existingTasks={uniqueTitles} />
                            {activeEntry ? (
                                <button className="bg-red-500 hover:bg-red-600 text-white rounded-lg px-6 h-[48px] font-bold shadow-lg flex items-center justify-center animate-pulse" onClick={() => handleUpdate({...activeEntry, end: Date.now()})}><IconStop className="w-6 h-6"/></button>
                            ) : (
                                <button className="bg-blue-600 hover:bg-blue-700 text-white rounded-lg px-6 h-[48px] font-bold shadow-lg flex items-center justify-center" onClick={() => startTask(newTaskTitle)}><IconPlay className="w-6 h-6"/></button>
                            )}
                        </div>
                    </div>
                    
                    <div className="flex-1 overflow-y-auto p-4 safe-pb space-y-6">
                        <div className="flex justify-center mb-4">
                            <button onClick={() => openManualModal(null)} className="flex items-center bg-white border border-slate-200 text-slate-700 px-4 py-2 rounded-full text-sm font-semibold shadow-sm hover:bg-slate-50 transition-colors">
                                <IconPlus className="w-4 h-4 mr-2" />
                                Manually Enter Task
                            </button>
                        </div>

                        {Object.keys(grouped).length === 0 && <div className="text-center text-slate-400 mt-10"><p>No recent tasks.</p></div>}
                        {Object.keys(grouped).map(date => (
                            <div key={date}>
                                <div className="sticky top-0 bg-slate-50/95 backdrop-blur py-1 mb-2 z-0 border-b border-slate-200"><h2 className="text-xs font-bold text-slate-500 uppercase tracking-wide">{date}</h2></div>
                                {grouped[date].map(entry => (
                                    <EntryCard 
                                        key={entry.id} 
                                        entry={entry} 
                                        onUpdate={handleUpdate} 
                                        onDelete={handleDelete} 
                                        onSplit={handleSplit}
                                        onEdit={openManualModal}
                                        onMerge={handleMerge}
                                        onRecategorize={setRecategorizeTarget}
                                        onRestart={handleRestartTask}
                                        canMerge={checkMergeability(entry)}
                                        existingTasks={uniqueTitles}
                                        tick={tick} 
                                    />
                                ))}
                            </div>
                        ))}
                        <div className="h-20"></div>
                    </div>

                    {manualModalOpen && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[100] px-4">
                            <form onSubmit={handleManualSubmit} className="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 space-y-4 max-h-[90vh] overflow-y-auto">
                                <div className="flex items-start justify-between">
                                    <div>
                                        <h3 className="text-lg font-bold text-slate-800">{editEntryId ? 'Edit Task' : 'Manually Enter Task'}</h3>
                                        <p className="text-sm text-slate-500">Task details and timing.</p>
                                    </div>
                                    <button type="button" onClick={() => setManualModalOpen(false)} className="text-slate-400 hover:text-slate-700"></button>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold sm:col-span-2">
                                        <span>Title</span>
                                        <AutocompleteInput
                                            value={manualForm.title}
                                            onChange={(val) => onModalTitleChange(val)}
                                            onSelect={(val) => onModalTitleChange(val)}
                                            existingTasks={uniqueTitles}
                                            className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                        />
                                    </label>
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                        <span>Date</span>
                                        <input
                                            type="date"
                                            className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                            value={manualForm.date}
                                            onChange={(e) => setManualForm({...manualForm, date: e.target.value})}
                                            required
                                        />
                                    </label>
                                    <div className="grid grid-cols-2 gap-2">
                                        <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                            <span>Start</span>
                                            <input
                                                type="time"
                                                className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                                value={manualForm.startTime}
                                                onChange={(e) => setManualForm({...manualForm, startTime: e.target.value})}
                                                required
                                            />
                                        </label>
                                        <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                            <span>End</span>
                                            <input
                                                type="time"
                                                className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                                value={manualForm.endTime}
                                                onChange={(e) => setManualForm({...manualForm, endTime: e.target.value})}
                                                required
                                            />
                                        </label>
                                    </div>
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                        <span>Charge Code</span>
                                        <input
                                            className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                            value={manualForm.chargeCode}
                                            onChange={(e) => setManualForm({...manualForm, chargeCode: e.target.value})}
                                            placeholder="Optional"
                                        />
                                    </label>
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                        <span>Category</span>
                                        <select
                                            className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                            value={manualForm.category}
                                            onChange={(e) => setManualForm({...manualForm, category: e.target.value})}
                                        >
                                            <option value="work">Work</option>
                                            <option value="non-work">Non-Work</option>
                                        </select>
                                    </label>
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold">
                                        <span>Task Color</span>
                                        <input
                                            type="color"
                                            className="w-full border border-slate-200 rounded-lg h-11 p-1 focus:outline-none focus:border-blue-400"
                                            value={manualForm.color || '#3b82f6'}
                                            onChange={(e) => setManualForm({...manualForm, color: e.target.value})}
                                        />
                                    </label>
                                    <label className="space-y-1 text-sm text-slate-700 font-semibold sm:col-span-2">
                                        <span>Description</span>
                                        <textarea
                                            className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-blue-400"
                                            rows={3}
                                            value={manualForm.description}
                                            onChange={(e) => setManualForm({...manualForm, description: e.target.value})}
                                            placeholder="Notes for this task"
                                        ></textarea>
                                    </label>
                                </div>

                                <div className="flex justify-end space-x-2 pt-2">
                                    <button type="button" onClick={() => setManualModalOpen(false)} className="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">Cancel</button>
                                    <button type="submit" className="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 flex items-center">
                                        <IconPlus className="w-4 h-4 mr-2" />
                                        {editEntryId ? 'Update' : 'Save'}
                                    </button>
                                </div>
                            </form>
                        </div>
                    )}

                    {recategorizeTarget && (
                        <div className="fixed inset-0 bg-slate-900/60 flex items-center justify-center z-[100] px-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-sm p-5 space-y-4">
                                <h3 className="text-lg font-bold text-slate-800">Recategorize Task</h3>
                                <p className="text-sm text-slate-500">Select an existing task to transform "{recategorizeTarget.title}" into.</p>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-slate-500 uppercase">New Task Title</label>
                                    <AutocompleteInput
                                        value={recatQuery} 
                                        onChange={setRecatQuery} 
                                        onSelect={(val) => handleRecategorize(val)}
                                        existingTasks={uniqueTitles}
                                        className="w-full border border-slate-200 rounded-lg p-2 focus:outline-none focus:border-indigo-400"
                                        autoFocus={true}
                                    />
                                </div>
                                <div className="flex justify-end pt-2">
                                    <button onClick={() => setRecategorizeTarget(null)} className="px-4 py-2 rounded-lg text-slate-600 hover:bg-slate-100">Cancel</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {splitTarget && splitTarget.end && (
                        <div className="fixed inset-0 bg-slate-900/50 flex items-center justify-center z-[100] px-4">
                            <div className="bg-white rounded-xl shadow-xl w-full max-w-md p-5 space-y-4">
                                <h3 className="text-lg font-bold text-slate-800">Split "{splitTarget.title}"</h3>
                                <div className="space-y-2">
                                    <div className="flex justify-between text-xs text-slate-500 font-mono">
                                        <span>{formatTime(splitTarget.start)}</span>
                                        <span>{formatTime(splitTarget.end)}</span>
                                    </div>
                                    <input
                                        type="range"
                                        min={splitTarget.start}
                                        max={splitTarget.end}
                                        step={60000}
                                        value={splitValue}
                                        onChange={(e) => setSplitValue(parseInt(e.target.value))}
                                        className="w-full"
                                    />
                                    <div className="text-sm text-slate-700 font-semibold text-center">
                                        Split at {formatTime(splitValue)}
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-2 pt-2">
                                    <button onClick={cancelSplit} className="px-4 py-2 rounded-lg text-slate-500 hover:bg-slate-100">Cancel</button>
                                    <button onClick={confirmSplit} className="px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700">Split Task</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ManageTasksView = ({ entries, updateEntries }) => {
            const [selectedMergeTask, setSelectedMergeTask] = useState(null);
            const [mergeTarget, setMergeTarget] = useState("");
            const [editTask, setEditTask] = useState(null);
            
            const taskStats = useMemo(() => {
                const stats = {};
                const now = Date.now();
                const ppBounds = getPayPeriodBounds(new Date(now));

                entries.forEach(e => {
                    if (!stats[e.title]) stats[e.title] = { 
                        title: e.title, total: 0, payPeriod: 0, count: 0, 
                        lastCode: e.chargeCode, lastCat: e.category, lastColor: e.color
                    };
                    const dur = ((e.end || now) - e.start);
                    stats[e.title].total += dur;
                    stats[e.title].count += 1;
                    if (e.start >= ppBounds.start && e.start <= ppBounds.end) stats[e.title].payPeriod += dur;
                });
                return Object.values(stats).sort((a,b) => b.total - a.total);
            }, [entries]);

            const fmtDur = (ms) => (ms / 3600000).toFixed(1) + 'h';
            
            const handleMerge = () => {
                console.log("Manage Merge:", selectedMergeTask, "->", mergeTarget);
                if (!selectedMergeTask || !mergeTarget || selectedMergeTask === mergeTarget) return;

                // Find target properties to apply to merged tasks
                const targetSample = entries.find(e => e.title === mergeTarget);

                if (safeConfirm(`Merge all history from "${selectedMergeTask}" into "${mergeTarget}"?`)) {
                    updateEntries(entries.map(e => {
                        if (e.title === selectedMergeTask) {
                            const newDesc = `[Was: ${selectedMergeTask}]\n${e.description || ''}`.trim();
                            return { 
                                ...e, 
                                title: mergeTarget, 
                                description: newDesc,
                                // Apply properties from the target task
                                chargeCode: targetSample ? targetSample.chargeCode : e.chargeCode,
                                category: targetSample ? targetSample.category : e.category,
                                color: targetSample ? targetSample.color : e.color
                            };
                        }
                        return e;
                    }));
                    setSelectedMergeTask(null);
                    setMergeTarget("");
                }
            };

            const handleSaveEdit = (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const oldTitle = editTask.title;
                const newTitle = formData.get('title');
                const newCode = formData.get('code');
                const newCat = formData.get('cat');
                const newColor = formData.get('color') || '#3b82f6';

                if(safeConfirm(`Update ALL entries for "${oldTitle}" with these settings?`)) {
                    updateEntries(entries.map(ent => {
                        if(ent.title === oldTitle) {
                            return { ...ent, title: newTitle, chargeCode: newCode, category: newCat, color: newColor };
                        }
                        return ent;
                    }));
                    setEditTask(null);
                }
            };
            
            const handleDelete = (title) => { if (safeConfirm(`Delete ALL entries for task "${title}"?`)) updateEntries(entries.filter(e => e.title !== title)); };

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="bg-white p-4 shadow-sm z-10 border-b border-slate-200 shrink-0">
                        <h2 className="text-xl font-bold text-slate-800">Manage Tasks</h2>
                        <p className="text-xs text-slate-500 mt-1">Aggregate view & bulk editing.</p>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 safe-pb space-y-4">
                        {editTask && (
                             <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                                <form onSubmit={handleSaveEdit} className="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
                                    <h3 className="font-bold text-lg mb-4">Edit Task: {editTask.title}</h3>
                                    <label className="block text-sm font-bold mb-1">Task Name</label>
                                    <input name="title" defaultValue={editTask.title} className="w-full border p-2 rounded mb-3" required />
                                    <label className="block text-sm font-bold mb-1">Default Charge Code</label>
                                    <input name="code" defaultValue={editTask.lastCode} className="w-full border p-2 rounded mb-3" />
                                    <label className="block text-sm font-bold mb-1">Task Color</label>
                                    <input name="color" type="color" defaultValue={editTask.lastColor || '#3b82f6'} className="w-full border p-2 rounded mb-3 h-12" />
                                    <label className="block text-sm font-bold mb-1">Category</label>
                                    <select name="cat" defaultValue={editTask.lastCat} className="w-full border p-2 rounded mb-6">
                                        <option value="work">Work</option>
                                        <option value="non-work">Non-Work</option>
                                    </select>
                                    <div className="flex justify-end space-x-2">
                                        <button type="button" onClick={()=>setEditTask(null)} className="px-4 py-2 text-slate-500">Cancel</button>
                                        <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded font-bold">Save All</button>
                                    </div>
                                </form>
                             </div>
                        )}

                        {selectedMergeTask && (
                            <div className="bg-blue-50 border border-blue-200 p-4 rounded-lg mb-4">
                                <h3 className="font-bold text-blue-800 text-sm mb-2">Merge "{selectedMergeTask}" into...</h3>
                                <select className="w-full p-2 border rounded mb-3 text-sm" value={mergeTarget} onChange={e => setMergeTarget(e.target.value)}>
                                    <option value="">Select Target Task...</option>
                                    {taskStats.filter(t => t.title !== selectedMergeTask).map(t => <option key={t.title} value={t.title}>{t.title}</option>)}
                                </select>
                                <div className="flex space-x-2">
                                    <button onClick={handleMerge} disabled={!mergeTarget} className="bg-blue-600 text-white px-3 py-1 rounded text-sm disabled:opacity-50">Confirm Merge</button>
                                    <button onClick={() => setSelectedMergeTask(null)} className="text-slate-500 px-3 py-1 text-sm">Cancel</button>
                                </div>
                            </div>
                        )}
                        {taskStats.map(stat => (
                            <div key={stat.title} className="bg-white rounded-lg shadow-sm p-4 border border-slate-100">
                                <div className="flex justify-between items-start mb-2">
                                    <div>
                                        <div className="flex items-center space-x-2">
                                            <span className="w-3 h-3 rounded-full border border-slate-200" style={{ backgroundColor: stat.lastColor || '#2563eb' }}></span>
                                            <h3 className="font-bold text-slate-800 text-lg">{stat.title}</h3>
                                        </div>
                                        <div className="flex items-center space-x-2 mt-1">
                                            <span className="text-xs bg-slate-100 px-2 py-0.5 rounded text-slate-600 font-mono border border-slate-200">{stat.lastCode || 'No Code'}</span>
                                            <span className={`text-xs px-2 py-0.5 rounded border ${stat.lastCat === 'work' ? 'bg-blue-50 text-blue-600 border-blue-200' : 'bg-orange-50 text-orange-600 border-orange-200'}`}>
                                                {stat.lastCat === 'work' ? 'Work' : 'Non-Work'}
                                            </span>
                                        </div>
                                    </div>
                                    <div className="flex space-x-1">
                                        <button onClick={() => setEditTask(stat)} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded"><IconEdit className="w-4 h-4" /></button>
                                        <button onClick={() => setSelectedMergeTask(stat.title)} className="p-1.5 text-slate-400 hover:text-orange-600 hover:bg-orange-50 rounded"><IconMerge className="w-4 h-4" /></button>
                                        <button onClick={() => handleDelete(stat.title)} className="p-1.5 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded"><IconTrash className="w-4 h-4" /></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-2 gap-2 mt-3 text-center">
                                    <div className="bg-slate-50 p-2 rounded"><div className="text-[10px] text-slate-400 uppercase font-bold">This PP</div><div className="font-mono text-sm font-bold text-slate-700">{fmtDur(stat.payPeriod)}</div></div>
                                    <div className="bg-slate-50 p-2 rounded"><div className="text-[10px] text-slate-400 uppercase font-bold">Lifetime</div><div className="font-mono text-sm font-bold text-slate-700">{fmtDur(stat.total)}</div></div>
                                </div>
                            </div>
                        ))}
                        <div className="h-20"></div>
                    </div>
                </div>
            );
        };

        const TimelineView = ({ entries }) => {
            const [selectedDate, setSelectedDate] = useState(getStartOfDay(new Date()));
            const scrollRef = useRef(null);

            const dayEntries = useMemo(() => {
                const nextDay = selectedDate + 86400000;
                return entries.filter(e => e.start < nextDay && (e.end || Date.now()) > selectedDate).sort((a,b) => a.start - b.start);
            }, [entries, selectedDate]);

            useEffect(() => {
                if (scrollRef.current) {
                    const now = new Date();
                    // Scroll to current time - 1 hour
                    const minutes = now.getHours() * 60 + now.getMinutes();
                    const totalMinutes = 24 * 60;
                    const percent = Math.max(0, (minutes - 60) / totalMinutes);
                    const scrollPos = scrollRef.current.scrollHeight * percent;
                    scrollRef.current.scrollTop = scrollPos;
                }
            }, []); // Run on mount

            const shiftDate = (days) => setSelectedDate(d => d + days * 86400000);
            const getPos = (ts) => Math.min(100, Math.max(0, (ts - selectedDate) / 86400000) * 100);
            const hours = Array.from({length: 25}, (_, i) => i);

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="bg-white p-4 shadow-sm z-10 flex justify-between items-center border-b border-slate-200 shrink-0">
                        <button onClick={() => shiftDate(-1)} className="p-2 hover:bg-slate-100 rounded-full"><IconChevronLeft className="w-5 h-5"/></button>
                        <h2 className="font-bold text-lg">{formatDate(selectedDate)}</h2>
                        <button onClick={() => shiftDate(1)} className="p-2 hover:bg-slate-100 rounded-full"><IconChevronRight className="w-5 h-5"/></button>
                    </div>
                    <div ref={scrollRef} className="flex-1 overflow-y-auto relative safe-pb scroll-smooth">
                        <div className="relative min-h-[2880px] w-full flex">
                            <div className="w-16 border-r border-slate-200 bg-slate-50 flex-shrink-0 relative">
                                {hours.map(h => <div key={h} className="absolute w-full text-right pr-2 text-xs text-slate-400 border-t border-slate-200" style={{top: `${(h/24)*100}%`, height: '1px'}}>{h}:00</div>)}
                            </div>
                            <div className="flex-1 relative bg-white">
                                {hours.map(h => <div key={h} className="absolute w-full border-t border-slate-100" style={{top: `${(h/24)*100}%`}}></div>)}
                                {dayEntries.map(e => {
                                    const top = getPos(e.start);
                                    const bottom = getPos(e.end || Date.now());
                                    const accent = e.color || '#2563eb';
                                    return (
                                        <div
                                            key={e.id}
                                            className="absolute left-2 right-2 rounded px-2 py-1 text-xs overflow-hidden border-l-4 opacity-90 shadow-sm bg-white"
                                            style={{
                                                top: `${top}%`,
                                                height: `${Math.max(0.2, bottom - top)}%`,
                                                borderLeftColor: accent,
                                                backgroundColor: withAlpha(accent, 0.18)
                                            }}
                                        >
                                            <div className="font-bold truncate">{formatTime(e.start)} - {e.title}</div>
                                            {e.description && <div className="truncate text-slate-600 text-[11px] mt-0.5">{e.description}</div>}
                                        </div>
                                    );
                                })}
                                {Date.now() >= selectedDate && Date.now() < selectedDate + 86400000 && (
                                    <div className="absolute w-full border-t-2 border-red-400 z-10 pointer-events-none" style={{top: `${getPos(Date.now())}%`}}><div className="absolute right-0 -mt-2 bg-red-400 text-white text-[10px] px-1 rounded-l">NOW</div></div>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TimesheetView = ({ entries }) => {
            const [groupByTask, setGroupByTask] = useState(false);
            const [ppIndex, setPpIndex] = useState(0); 
            
            const payPeriods = useMemo(() => {
                const periods = {};
                const currBounds = getPayPeriodBounds(new Date());
                periods[currBounds.label] = { ...currBounds, entries: [] };

                entries.forEach(e => {
                    const d = new Date(e.start);
                    const b = getPayPeriodBounds(d);
                    if (!periods[b.label]) periods[b.label] = { ...b, entries: [] };
                    periods[b.label].entries.push(e);
                });
                return Object.values(periods).sort((a,b) => b.start - a.start);
            }, [entries]);

            const activePP = payPeriods[ppIndex] || payPeriods[0];
            
            const daysInPP = useMemo(() => {
                if(!activePP) return [];
                const d = [];
                let c = activePP.start;
                while(c <= activePP.end) {
                    d.push(new Date(c));
                    c += 86400000;
                }
                return d;
            }, [activePP]);

            const reportData = useMemo(() => {
                if(!activePP) return {rows: [], total: 0, workDays: 0};
                const rows = {};
                let total = 0;
                entries.filter(e => e.start >= activePP.start && e.start <= activePP.end && e.category === 'work').forEach(e => {
                     const key = groupByTask ? e.title : (e.chargeCode || 'Uncoded');
                     if(!rows[key]) rows[key] = { name: key, total: 0, daily: {} };
                     
                     const dStr = new Date(e.start).toDateString();
                     const hrs = ((e.end || Date.now()) - e.start) / 3600000;
                     rows[key].daily[dStr] = (rows[key].daily[dStr] || 0) + hrs;
                     rows[key].total += hrs;
                     total += hrs;
                });
                const workDays = countWorkDays(activePP.start, activePP.end);
                return { rows: Object.values(rows), total, workDays };
            }, [entries, activePP, groupByTask]);

            return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="bg-white p-4 shadow-sm z-10 border-b border-slate-200 sticky top-0 shrink-0">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800">Timesheet</h2>
                             <label className="flex items-center space-x-2 text-xs font-bold text-slate-600 select-none cursor-pointer">
                                <span>Code</span>
                                <div className={`w-8 h-4 rounded-full p-0.5 transition-colors ${groupByTask ? 'bg-blue-500' : 'bg-slate-300'}`} onClick={() => setGroupByTask(!groupByTask)}>
                                    <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform ${groupByTask ? 'translate-x-4' : 'translate-x-0'}`}></div>
                                </div>
                                <span>Task</span>
                            </label>
                        </div>
                        
                        <div className="flex items-center justify-between bg-slate-100 rounded-lg p-1 mb-2">
                             <button onClick={() => setPpIndex(Math.min(payPeriods.length-1, ppIndex+1))} disabled={ppIndex >= payPeriods.length-1} className="p-2 disabled:opacity-30"><IconChevronLeft className="w-5 h-5"/></button>
                             <div className="text-sm font-bold text-center">{activePP ? activePP.label : "Loading..."}</div>
                             <button onClick={() => setPpIndex(Math.max(0, ppIndex-1))} disabled={ppIndex <= 0} className="p-2 disabled:opacity-30"><IconChevronRight className="w-5 h-5"/></button>
                        </div>
                        
                        <div className="flex justify-between text-xs font-bold text-slate-500 bg-slate-50 p-2 rounded border border-slate-200">
                             <div>Recorded: <span className="text-slate-800">{reportData.total.toFixed(1)}h</span></div>
                             <div>Expected: <span className="text-slate-800">{(reportData.workDays * 8).toFixed(1)}h</span></div>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 safe-pb space-y-4">
                        {daysInPP.map(d => {
                            const dStr = d.toDateString();
                            const isWknd = isWeekend(d.getTime());
                            const dayTotal = reportData.rows.reduce((acc, r) => acc + (r.daily[dStr] || 0), 0);
                            const hasWork = dayTotal > 0;
                            
                            return (
                                <div key={dStr} className={`rounded-lg border p-3 ${isWknd ? 'bg-slate-50 border-slate-200' : 'bg-white border-slate-200'}`}>
                                    <div className="flex justify-between items-center mb-2">
                                        <div className="flex items-baseline space-x-2">
                                            <span className={`font-bold ${isWknd ? 'text-slate-400' : 'text-slate-800'}`}>{d.toLocaleDateString([], {weekday:'short', day:'numeric'})}</span>
                                            {isWknd && <span className="text-[10px] uppercase text-slate-400 font-bold">Weekend</span>}
                                        </div>
                                        <span className={`font-mono font-bold ${hasWork ? 'text-blue-600' : 'text-slate-300'}`}>{dayTotal.toFixed(1)}h</span>
                                    </div>
                                    {hasWork && (
                                        <div className="space-y-1 pl-2 border-l-2 border-slate-100">
                                            {reportData.rows.map(row => {
                                                const hrs = row.daily[dStr];
                                                if(!hrs) return null;
                                                return (
                                                    <div key={row.name} className="flex justify-between text-sm">
                                                        <span className="text-slate-600 truncate max-w-[200px]">{row.name}</span>
                                                        <span className="font-mono text-slate-700">{hrs.toFixed(1)}</span>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                        <div className="h-20"></div>
                    </div>
                </div>
            );
        };

        const AnalyticsView = ({ entries }) => {
            const burndownRef = useRef(null);
            const trendRef = useRef(null);
            const pieRef = useRef(null);
            const chartInstances = useRef({});

            const [range, setRange] = useState('pay-period');
            const [includeNonWork, setIncludeNonWork] = useState(false);
            const [groupPieByTask, setGroupPieByTask] = useState(false);
            const includeToggleId = 'include-non-work-checkbox';

            useEffect(() => {
                const now = new Date();
                let startLimit = 0, endLimit = Date.now() + 86400000;
                let goal = 0;
                
                if (range === 'today') { startLimit = getStartOfDay(now); goal = 8; }
                else if (range === 'week') { 
                    const d = new Date(now); 
                    const day = d.getDay() || 7; 
                    if(day !== 1) d.setHours(-24 * (day - 1)); else d.setHours(0,0,0,0);
                    startLimit = d.getTime(); 
                    goal = 40;
                } 
                else if (range === 'pay-period') { 
                    const b = getPayPeriodBounds(now); 
                    startLimit = b.start; endLimit = b.end;
                    goal = countWorkDays(b.start, b.end) * 8; 
                }
                else if (range === 'month') { const d = new Date(now); d.setDate(1); d.setHours(0,0,0,0); startLimit = d.getTime(); }
                else if (range === 'year') { const d = new Date(now); d.setMonth(0, 1); d.setHours(0,0,0,0); startLimit = d.getTime(); }
                else startLimit = 0;

                let filtered = entries.filter(e => {
                    const end = e.end || Date.now();
                    return end >= startLimit && e.start <= endLimit;
                });

                if (!includeNonWork) filtered = filtered.filter(e => e.category === 'work');

                const pieGroups = {};
                const pieColors = {};
                filtered.forEach(e => {
                    const dur = ((e.end || Date.now()) - e.start);
                    const key = groupPieByTask ? (e.title || 'Untitled Task') : (e.chargeCode || 'Uncoded');
                    pieGroups[key] = (pieGroups[key] || 0) + dur;
                    if (groupPieByTask && !pieColors[key] && e.color) pieColors[key] = e.color;
                });
                if (pieRef.current) {
                    if (chartInstances.current.pie) chartInstances.current.pie.destroy();
                    const labels = Object.keys(pieGroups);
                    const usedColorSet = new Set(Object.values(pieColors));
                    const backgroundColor = labels.map((label, idx) => {
                        if (groupPieByTask) {
                            if (!pieColors[label]) {
                                const color = pickNextColor(usedColorSet);
                                usedColorSet.add(color);
                                pieColors[label] = color;
                            }
                            return pieColors[label];
                        }
                        return TASK_COLORS[idx % TASK_COLORS.length];
                    });

                    chartInstances.current.pie = new Chart(pieRef.current, {
                        type: 'doughnut',
                        data: {
                            labels,
                            datasets: [{ data: labels.map(k => (pieGroups[k]/3600000)), backgroundColor, borderWidth: 0 }]
                        },
                        options: { responsive: true, animation: false, plugins: { legend: { position: 'right', labels: { boxWidth: 10 } }, title: { display: true, text: groupPieByTask ? 'Hours by Task' : 'Hours by Code' } } }
                    });
                }

                const workEntries = entries.filter(e => e.category === 'work' && e.start >= startLimit && e.start <= endLimit);
                let trendLabels = [];
                let trendData = [];
                let weekendMask = [];

                if (range === 'year') {
                    const weekBuckets = {};
                    workEntries.forEach(e => {
                        const d = new Date(e.start);
                        const day = d.getDay();
                        const diff = day === 0 ? -6 : 1 - day;
                        d.setDate(d.getDate() + diff);
                        d.setHours(0,0,0,0);
                        const key = d.getTime();
                        if (!weekBuckets[key]) weekBuckets[key] = { hours: 0, days: 0 };
                        weekBuckets[key].hours += ((e.end || Date.now()) - e.start) / 3600000;
                        weekBuckets[key].days = 7;
                    });
                    const sortedWeeks = Object.keys(weekBuckets).map(k => parseInt(k)).sort((a,b) => a-b);
                    trendLabels = sortedWeeks.map(ts => new Date(ts).toLocaleDateString([], { month: 'short', day: 'numeric' }));
                    trendData = sortedWeeks.map(ts => weekBuckets[ts].hours / weekBuckets[ts].days);
                    weekendMask = sortedWeeks.map(() => false);
                } else {
                    const startTs = startLimit !== 0 ? startLimit : (workEntries.length ? workEntries.reduce((min, e) => Math.min(min, e.start), workEntries[0]?.start || Date.now()) : Date.now());
                    const startDay = new Date(startTs);
                    startDay.setHours(0,0,0,0);
                    const endDay = new Date(endLimit);
                    endDay.setHours(23,59,59,999);
                    const dayHours = [];
                    const labels = [];
                    const masks = [];
                    for (let d = new Date(startDay); d <= endDay; d.setDate(d.getDate() + 1)) {
                        const dayStart = d.getTime();
                        const dayEnd = dayStart + 86400000;
                        const hrs = workEntries
                            .filter(e => e.start >= dayStart && e.start < dayEnd)
                            .reduce((sum, e) => sum + ((e.end || Date.now()) - e.start) / 3600000, 0);
                        labels.push(d.toLocaleDateString([], { month: 'short', day: 'numeric' }));
                        dayHours.push(hrs);
                        masks.push(isWeekend(dayStart));
                    }
                    trendLabels = labels;
                    trendData = dayHours;
                    weekendMask = masks;
                }

                if (trendRef.current) {
                    if (chartInstances.current.trend) chartInstances.current.trend.destroy();
                    chartInstances.current.trend = new Chart(trendRef.current, {
                        type: 'line',
                        data: {
                            labels: trendLabels,
                            datasets: [{
                                label: range === 'year' ? 'Avg Hours per Day (Weekly View)' : 'Work Hours per Day',
                                data: trendData,
                                fill: false,
                                borderColor: '#2563eb',
                                backgroundColor: '#2563eb',
                                tension: 0.2,
                                pointBackgroundColor: weekendMask.map(w => w ? '#cbd5e1' : '#2563eb'),
                                pointBorderColor: weekendMask.map(w => w ? '#cbd5e1' : '#2563eb'),
                                segment: { borderColor: ctx => weekendMask[ctx.p1DataIndex] ? '#cbd5e1' : '#2563eb' }
                            }]
                        },
                        options: {
                            responsive: true,
                            animation: false,
                            plugins: { legend: { display: false }, title: { display: true, text: 'Work Hours Trend' } },
                            scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' } } }
                        }
                    });
                }

                if ((range === 'today' || range === 'week' || range === 'pay-period') && burndownRef.current) {
                    const workEntries = entries.filter(e => e.category === 'work' && e.start >= startLimit && e.start <= endLimit).sort((a,b)=>a.start-b.start);
                    
                    const points = [];
                    let remaining = goal;
                    
                    const startLabel = range === 'today' ? formatTime(startLimit) : formatDate(startLimit);
                    points.push({x: startLabel, y: goal});
                    
                    workEntries.forEach(e => {
                        const dur = ((e.end || Date.now()) - e.start) / 3600000;
                        remaining -= dur;
                        points.push({ x: range === 'today' ? formatTime(e.end || Date.now()) : formatDate(e.end || Date.now()), y: Math.max(0, remaining) });
                    });

                    if (chartInstances.current.bd) chartInstances.current.bd.destroy();
                    chartInstances.current.bd = new Chart(burndownRef.current, {
                        type: 'line',
                        data: {
                            labels: points.map(p => p.x),
                            datasets: [{
                                label: `Remaining (Goal: ${goal}h)`, data: points.map(p => p.y),
                                borderColor: '#f43f5e', backgroundColor: 'rgba(244, 63, 94, 0.1)', fill: true, tension: 0.1
                            }]
                        },
                        options: { responsive: true, animation: false, scales: { y: { beginAtZero: true, max: goal } } }
                    });
                } else if (chartInstances.current.bd) {
                    chartInstances.current.bd.destroy(); chartInstances.current.bd = null;
                }

                return () => Object.values(chartInstances.current).forEach(c => c && c.destroy());
            }, [entries, range, includeNonWork, groupPieByTask]);

            return (
                <div className="flex flex-col h-full bg-slate-50 overflow-y-auto pb-20">
                    <div className="p-4">
                        <div className="flex justify-between items-center mb-4">
                            <h2 className="text-xl font-bold text-slate-800">Analytics</h2>
                            <label className="flex items-center space-x-2 text-xs font-bold text-slate-600 select-none cursor-pointer">
                                <span>Code</span>
                                <div className={`w-8 h-4 rounded-full p-0.5 transition-colors ${groupPieByTask ? 'bg-blue-500' : 'bg-slate-300'}`} onClick={() => setGroupPieByTask(!groupPieByTask)}>
                                    <div className={`w-3 h-3 bg-white rounded-full shadow-sm transform transition-transform ${groupPieByTask ? 'translate-x-4' : 'translate-x-0'}`}></div>
                                </div>
                                <span>Task</span>
                            </label>
                        </div>
                        <div className="flex flex-wrap gap-2 mb-4">
                            {['today','week','pay-period','month','year'].map(r => (
                                <button key={r} onClick={()=>setRange(r)} className={`px-3 py-1 rounded-full text-xs font-bold uppercase ${range === r ? 'bg-blue-600 text-white' : 'bg-white text-slate-600 border border-slate-200'}`}>{r}</button>
                            ))}
                        </div>
                        <div className="flex items-center mb-4 gap-4 flex-wrap">
                             <div className="flex items-center space-x-2 text-sm text-slate-600 cursor-pointer select-none">
                                <input
                                    id={includeToggleId}
                                    type="checkbox"
                                    className="sr-only"
                                    checked={includeNonWork}
                                    onChange={() => setIncludeNonWork(!includeNonWork)}
                                />
                                <label htmlFor={includeToggleId} className="flex items-center space-x-2">
                                    <div className={`w-5 h-5 rounded border flex items-center justify-center ${includeNonWork ? 'bg-blue-500 border-blue-500' : 'bg-white border-slate-300'}`}>
                                        {includeNonWork && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><polyline points="20 6 9 17 4 12"/></svg>}
                                    </div>
                                    <span>Include Non-Work Tasks</span>
                                </label>
                             </div>
                        </div>
                        {(range === 'today' || range === 'week' || range === 'pay-period') && (
                            <div className="bg-white p-4 rounded-xl shadow-sm mb-6">
                                <canvas ref={burndownRef}></canvas>
                            </div>
                        )}
                        <div className="bg-white p-4 rounded-xl shadow-sm mb-6"><canvas ref={pieRef}></canvas></div>
                        <div className="bg-white p-4 rounded-xl shadow-sm">
                            <canvas ref={trendRef}></canvas>
                        </div>
                        <div className="h-20"></div>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ entries, updateEntries }) => {
            const fileInputRef = useRef();
            const handleExport = () => {
                const header = "id,title,start,end,chargeCode,category,color,description,duration_minutes\n";
                const rows = entries.map(e => {
                    const dur = ((e.end || Date.now()) - e.start) / 60000;
                    const desc = (e.description || '').replace(/"/g, '""');
                    return `"${e.id}","${e.title}",${e.start},${e.end || ''},"${e.chargeCode||''}","${e.category}","${e.color || ''}","${desc}",${dur.toFixed(2)}`;
                }).join("\n");
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([header + rows], { type: 'text/csv' }));
                a.download = `timesheet_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
            };
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const lines = evt.target.result.split("\n").slice(1);
                    const newEntries = [...entries];
                    const existingIds = new Set(entries.map(e => e.id));
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        const cols = line.split(",").map(s => s.replace(/^"|"$/g, ''));
                        if (cols.length >= 6 && !existingIds.has(cols[0])) {
                            const hasColorColumn = cols.length >= 8;
                            const color = hasColorColumn ? cols[6] : '';
                            const description = hasColorColumn ? (cols[7] || '') : (cols[6] || '');
                            newEntries.push({ id: cols[0], title: cols[1], start: parseInt(cols[2]), end: cols[3] ? parseInt(cols[3]) : null, chargeCode: cols[4], category: cols[5], color, description });
                        }
                    });
                    updateEntries(newEntries);
                    alert("Import successful.");
                };
                reader.readAsText(file);
            };

            return (
                <div className="p-4 h-full bg-slate-50">
                    <h2 className="text-xl font-bold mb-6 text-slate-800">Data Management</h2>
                    <div className="space-y-4">
                        <div className="bg-white p-4 rounded-lg shadow-sm">
                            <h3 className="font-semibold mb-2">Export Data</h3>
                            <button onClick={handleExport} className="w-full bg-blue-600 text-white py-2 rounded font-medium hover:bg-blue-700">Download CSV</button>
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-sm">
                            <h3 className="font-semibold mb-2">Import Data</h3>
                            <input type="file" accept=".csv" ref={fileInputRef} onChange={handleImport} className="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                        </div>
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-red-100">
                            <h3 className="font-semibold text-red-600 mb-2">Danger Zone</h3>
                            <button onClick={() => safeConfirm("Delete ALL data?") && updateEntries([])} className="w-full border border-red-500 text-red-500 py-2 rounded font-medium hover:bg-red-50">Clear All Data</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [entries, updateEntries] = useTimesheetData();
            const [tick, setTick] = useState(0);

            useEffect(() => {
                const timer = setInterval(() => {
                    setTick(t => t + 1);
                    const now = Date.now();
                    const active = entries.find(e => !e.end);
                    if (active && (now - active.start > 24 * 60 * 60 * 1000)) {
                         updateEntries(entries.map(e => e.id === active.id ? {...e, end: active.start + (24 * 60 * 60 * 1000)} : e));
                    }
                }, 1000);
                return () => clearInterval(timer);
            }, [entries]);

            useEffect(() => {
                if ('serviceWorker' in navigator && !window.location.href.startsWith('blob:')) {
                    try {
                        const swCode = `
                            self.addEventListener('install', e => e.waitUntil(self.skipWaiting()));
                            self.addEventListener('activate', e => e.waitUntil(self.clients.claim()));
                            self.addEventListener('fetch', e => e.respondWith(fetch(e.request).catch(() => caches.match(e.request))));
                        `;
                        const blob = new Blob([swCode], {type: 'application/javascript'});
                        const swUrl = URL.createObjectURL(blob);
                        navigator.serviceWorker.register(swUrl).catch(e => console.log("SW Reg failed:", e));
                    } catch(e) { console.log("SW not supported here"); }
                }
            }, []);

            return (
                <div className="flex flex-col h-full w-full max-w-md mx-auto bg-slate-50 shadow-2xl overflow-hidden relative min-h-[100dvh]">
                    <div className="flex-1 overflow-hidden relative">
                        {view === 'home' && <HomeView entries={entries} updateEntries={updateEntries} tick={tick} />}
                        {view === 'timeline' && <TimelineView entries={entries} />}
                        {view === 'timesheet' && <TimesheetView entries={entries} />}
                        {view === 'manage' && <ManageTasksView entries={entries} updateEntries={updateEntries} />}
                        {view === 'analytics' && <AnalyticsView entries={entries} />}
                        {view === 'settings' && <SettingsView entries={entries} updateEntries={updateEntries} />}
                    </div>

                    <div className="bg-white border-t border-slate-200 fixed bottom-0 w-full max-w-md pt-3 pb-6 px-2 flex items-center justify-around z-50">
                        <button onClick={() => setView('home')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'home' ? 'text-blue-600' : 'text-slate-400'}`}><IconList className="w-6 h-6" /><span className="text-[10px] font-medium">Log</span></button>
                        <button onClick={() => setView('timeline')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'timeline' ? 'text-blue-600' : 'text-slate-400'}`}><IconCalendar className="w-6 h-6" /><span className="text-[10px] font-medium">Timeline</span></button>
                        <button onClick={() => setView('timesheet')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'timesheet' ? 'text-blue-600' : 'text-slate-400'}`}><IconTable className="w-6 h-6" /><span className="text-[10px] font-medium">Sheet</span></button>
                        <button onClick={() => setView('manage')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'manage' ? 'text-blue-600' : 'text-slate-400'}`}><IconFolder className="w-6 h-6" /><span className="text-[10px] font-medium">Manage</span></button>
                        <button onClick={() => setView('analytics')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'analytics' ? 'text-blue-600' : 'text-slate-400'}`}><IconChart className="w-6 h-6" /><span className="text-[10px] font-medium">Stats</span></button>
                        <button onClick={() => setView('settings')} className={`flex flex-col items-center justify-center min-w-[3.5rem] space-y-1 ${view === 'settings' ? 'text-blue-600' : 'text-slate-400'}`}><IconSettings className="w-6 h-6" /><span className="text-[10px] font-medium">Data</span></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
